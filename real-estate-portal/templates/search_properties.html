<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Properties</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="text-center mb-4">Search Properties</h1>
        <div class="mb-4">
            <div class="row">
                <div class="col-md-3">
                    <select id="location" class="form-control">
                        <option value="">All Locations</option>
                        {% for loc in locations %}
                            <option value="{{ loc }}" {% if request.args.get('location') == loc %}selected{% endif %}>{{ loc }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <input id="min_price" type="number" class="form-control" placeholder="Min Price" value="{{ request.args.get('min_price', '') }}">
                </div>
                <div class="col-md-2">
                    <input id="max_price" type="number" class="form-control" placeholder="Max Price" value="{{ request.args.get('max_price', '') }}">
                </div>
                <div class="col-md-3">
                    <select id="property_type" class="form-control">
                        <option value="">All Types</option>
                        <option value="apartment" {% if request.args.get('property_type') == 'apartment' %}selected{% endif %}>Apartment</option>
                        <option value="house" {% if request.args.get('property_type') == 'house' %}selected{% endif %}>House</option>
                        <option value="land" {% if request.args.get('property_type') == 'land' %}selected{% endif %}>Land</option>
                        <option value="commercial" {% if request.args.get('property_type') == 'commercial' %}selected{% endif %}>Commercial</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input id="bedrooms" type="number" class="form-control" placeholder="Min Bedrooms" value="{{ request.args.get('bedrooms', '') }}">
                </div>
            </div>
        </div>
        <div id="results" class="row">
            {% for p in properties %}
                <div class="col-md-4 mb-4">
                    <div class="card shadow">
                        {% if p.images %}
                            <img src="{{ url_for('static', filename=p.images[0].filename) }}" class="card-img-top" alt="Property Image">
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">{{ p.title }}</h5>
                            <p class="card-text">Price: ${{ p.price }}</p>
                            <p class="card-text">Location: <a href="https://www.google.com/maps?q={{ p.location }}" target="_blank">{{ p.location }}</a></p>
                            <p class="card-text">Address: {{ p.address }}</p>
                            <p class="card-text">Amenities: {{ p.amenities }}</p>
                            <a href="{{ url_for('property_detail', property_id=p.id) }}" class="btn btn-primary">View Details</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function updateResults() {
            const location = document.getElementById('location').value;
            const min_price = document.getElementById('min_price').value;
            const max_price = document.getElementById('max_price').value;
            const property_type = document.getElementById('property_type').value;
            const bedrooms = document.getElementById('bedrooms').value;

            const params = new URLSearchParams({
                location: location,
                min_price: min_price,
                max_price: max_price,
                property_type: property_type,
                bedrooms: bedrooms
            });

            fetch(`/search-results?${params}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('results').innerHTML = html;
                });
        }

        // Add event listeners to inputs
        document.getElementById('location').addEventListener('input', updateResults);
        document.getElementById('min_price').addEventListener('input', updateResults);
        document.getElementById('max_price').addEventListener('input', updateResults);
        document.getElementById('property_type').addEventListener('change', updateResults);
        document.getElementById('bedrooms').addEventListener('input', updateResults);

        // Favorite toggle
        document.addEventListener('click', function(e) {
            if (e.target.closest('.favorite-btn')) {
                e.preventDefault();
                const btn = e.target.closest('.favorite-btn');
                const propertyId = btn.dataset.propertyId;
                const icon = btn.querySelector('i');

                fetch(`/toggle-favorite/${propertyId}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.favorited) {
                            icon.classList.add('text-danger');
                        } else {
                            icon.classList.remove('text-danger');
                        }
                    });
            }
        });
    </script>
</body>
</html>